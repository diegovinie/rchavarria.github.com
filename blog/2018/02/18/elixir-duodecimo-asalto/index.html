
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Elixir: duodécimo asalto - R. Chavarria's Blog</title>
  <meta name="author" content="Rub&eacute;n Chavarr&iacute;a">

  
  <meta name="description" content="Este será el último asalto relativo a Elixir por ahora, y en él aprenderemos
qué son las Tasks y los Agents, que se podrían traducir como tareas y &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://rchavarria.github.io/blog/2018/02/18/elixir-duodecimo-asalto/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="R. Chavarria's Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-36829645-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">R. Chavarria's Blog</a></h1>
  
    <h2>Proud of developing software, proud of being an Engineer</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:rchavarria.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archivos</a></li>
  <li><a href="/readings">Lista de lectura</a></li>
  <li><a href="/pet-projects">Proyectos</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Elixir: duodécimo asalto</h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-02-18T22:08:00+01:00" pubdate data-updated="true">Feb 18<span>th</span>, 2018</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Este será el último asalto relativo a <a href="http://elixir-lang.org/">Elixir</a> por ahora, y en él aprenderemos
qué son las <a href="https://hexdocs.pm/elixir/Task.html">Tasks</a> y los <a href="https://hexdocs.pm/elixir/Agent.html">Agents</a>, que se podrían traducir como <em>tareas</em> y
<em>agentes</em>.</p>

<p>Éstas serán las dos últimas abstracciones de Elixir que vamos a estudiar. No
son de tan bajo nivel como las primitivas <code>spawn</code>, <code>send</code> y <code>receive</code> que vimos
en el <a href="/blog/2016/09/18/elixir-septimo-asalto/">séptimo asalto</a> y tampoco son tan pesados como el <a href="http://erlang.org/doc/">framework OTP</a>.</p>

<p>Son un punto intermedio. Utilizan funcionalidades de OTP, pero nos aíslan de
muchos detalles, lo que hace que trabajar con procesos y procesos distribuidos
sea muchísimo más fácil.</p>

<p><img class="center" src="/images/2018/down-the-board.jpg"></p>

<div style="text-align: center">
  <span style="font-size: 60%">
Imagen basada en <a href="https://flic.kr/p/majY5a">Down the board</a> de <a href="https://www.flickr.com/photos/erinthomaswilson/">Erin</a>, <a href="https://creativecommons.org/licenses/by-nc-nd/2.0/">algunos derechos reservados</a>, licencia: <a href="https://creativecommons.org/licenses/by-nc-nd/2.0/">CC BY-NC-ND 2.0</a>
  </span>
</div>




<!-- more -->


<p>Todo esto, siguiendo el <a href="/blog/2016/01/17/aprendiendo-elixir/">método de aprendizaje</a> con el que comenzé la serie:</p>

<ul>
<li>Aprender lo suficiente para comenzar</li>
<li>Experimentar, jugar, buscar puntos desconocidos, hacerse preguntas</li>
<li>Aprender lo suficiente para hacer algo de utilidad</li>
<li>Enseñar lo aprendido</li>
</ul>


<h2>Aprender lo suficiente para comenzar</h2>

<h4>Tareas</h4>

<p>Una tarea o <code>Task</code> es una función que se ejecuta en segundo plano. Existen dos
funciones principales: <code>async</code> y <code>await</code> y su forma de usarla sería la
siguiente:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ...
</span><span class='line'># Realizar una computación que tarde mucho tiempo
</span><span class='line'>worker = Task.async(fn -&gt; Fibonacci.of(200000) end)
</span><span class='line'># ...
</span><span class='line'># Obtener el valor devuelto por la función
</span><span class='line'>result = Task.await(worker)
</span><span class='line'># ...</span></code></pre></td></tr></table></div></figure>


<p><code>async</code> crea un proceso separado que ejecuta la función. Devuelve un descriptor
del proceso o <em>worker</em>. <code>await</code> espera a que el proceso termine para recuperar
el valor devuelto por la función. En lugar de pasar una función, también
podemos pasar el nombre de un módulo, función y parámetros:
<code>Task.async(Fibonacci, :of, [ 200000 ])</code>.</p>

<p>Las <code>Task</code>s están implementadas como servidores OTP, por lo que podemos
incluirlas en nuestro árbol de supervisión de aplicaciones. Existen dos formas:</p>

<ol>
<li>Pasando la función a ejecutar a <code>Task.start_link</code> en lugar de llamar a
<code>Task.async</code> desde un proceso que ya esté supervisado</li>
<li>Creando un worker desde un supervisor:</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import Supervisor.Spec
</span><span class='line'>children = [
</span><span class='line'>  worker(Task, [ fn -&gt; do_something_extraordinary() end ])
</span><span class='line'>]
</span><span class='line'>supervise children, strategy: :one_for_one</span></code></pre></td></tr></table></div></figure>


<h4>Agentes</h4>

<p>Un agente o <code>Agent</code> es un proceso también en segundo plano que mantiene un
estado. El estado puede ser accedido desde un proceso, nodo o múltiples nodos.</p>

<p>El estado inicial se toma desde una función que se le pasa a la hora de
arrancar el <code>Agent</code>.</p>

<p>Se utiliza <code>Agent.get</code> para obtener el estado. Hay que pasarle una función,
cuyo parámetro será el estado actual del <code>Agent</code>. El valor devuelto por
<code>Agent.get</code> es el valor devuelto por la función.</p>

<p>Se utiliza <code>Agent.update</code> para modificar el estado. También hay que pasar una
función. El valor devuelto por la función será el nuevo estado.</p>

<p>Veamos un ejemplo:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># count es el descriptor del Agent
</span><span class='line'>iex&gt; { :ok, count } = Agent.start(fn -&gt; 0 end)
</span><span class='line'>{:ok, #PID&lt;0.69.0&gt;}
</span><span class='line'>iex&gt; Agent.get(count, &(&1))
</span><span class='line'>0            
</span><span class='line'># incrementa el en uno el estado
</span><span class='line'>iex&gt; Agent.update(count, &(&1+1))
</span><span class='line'>:ok          
</span><span class='line'>iex&gt; Agent.update(count, &(&1+1))
</span><span class='line'>:ok          
</span><span class='line'># obtiene el estado actual
</span><span class='line'>iex&gt; Agent.get(count, &(&1))
</span><span class='line'>2</span></code></pre></td></tr></table></div></figure>


<p>Los agentes son una abstracción especialmente pensada para almacenar el estado
de nuestros procesos. Por lo tanto, se recomienda no guardar el estado en
nuestros procesos, si no que los procesos que creemos nosotros usen un <code>Agent</code>
para almacenar. De esta forma, en caso de fallo en nuestro proceso, el estado
estará todavía disponible en el <code>Agent</code>, ya que es un proceso diferente al
nuestro.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Ruben Chavarria</span></span>

      








  


<time datetime="2018-02-18T22:08:00+01:00" pubdate data-updated="true">Feb 18<span>th</span>, 2018</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/elixir/'>elixir</a>, <a class='category' href='/blog/categories/learning/'>learning</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://rchavarria.github.io/blog/2018/02/18/elixir-duodecimo-asalto/" data-via="rchavarriat" data-counturl="http://rchavarria.github.io/blog/2018/02/18/elixir-duodecimo-asalto/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2018/01/17/practical-object-oriented-design-in-ruby/" title="Previous Post: Practical Object-Oriented Design in Ruby">&laquo; Practical Object-Oriented Design in Ruby</a>
      
      
        <a class="basic-alignment right" href="/blog/2018/03/06/madrid-software-crafters/" title="Next Post: Madrid Software Crafters 2018">Madrid Software Crafters 2018 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/03/16/arrays-vs-observables/">Programación reactiva con RxJS: comparando arrays con Observables</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/03/06/madrid-software-crafters/">Madrid Software Crafters 2018</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/02/18/elixir-duodecimo-asalto/">Elixir: duodécimo asalto</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/01/17/practical-object-oriented-design-in-ruby/">Practical Object-Oriented Design in Ruby</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/12/12/programacion-reactiva-javascript/">Programación reactiva en JavaScript</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("rchavarriat", 4, true);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <p>Follow <a href="http://twitter.com/rchavarriat">@rchavarriat</a></p>
  
</section>


<section>
  <h1>On Delicious</h1>
  <div id="delicious"></div>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/json/rchavarriat?count=5&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
  <p><a href="http://delicious.com/rchavarriat">My Delicious Bookmarks &raquo;</a></p>
</section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Rub&eacute;n Chavarr&iacute;a -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'rchavarria-github-com';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://rchavarria.github.io/blog/2018/02/18/elixir-duodecimo-asalto/';
        var disqus_url = 'http://rchavarria.github.io/blog/2018/02/18/elixir-duodecimo-asalto/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
